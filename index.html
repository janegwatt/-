<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è³“æœéŠæˆ²</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
* { -webkit-tap-highlight-color: transparent; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ===== å…±ç”¨å„²å­˜ ===== */
const storage = {
  get: (k) => localStorage.getItem(k),
  set: (k, v) => localStorage.setItem(k, v)
};

/* ===== ä¸»ç¨‹å¼ ===== */
function BingoGame() {
  const [mode, setMode] = useState("select");

  /* ç©å®¶ */
  const [playerName, setPlayerName] = useState("");
  const [inputPlayerName, setInputPlayerName] = useState("");
  const [playerBoard, setPlayerBoard] = useState([]);
  const [markedCells, setMarkedCells] = useState([]);
  const [bingoLines, setBingoLines] = useState(0);
  const [playerRecordedNumbers, setPlayerRecordedNumbers] = useState([]);

  /* ä¸»æŒäºº */
  const [hostBoard, setHostBoard] = useState([]);
  const [hostMarkedCells, setHostMarkedCells] = useState([]);
  const [hostBingoLines, setHostBingoLines] = useState(0);
  const [players, setPlayers] = useState([]);
  const [winner, setWinner] = useState(null);

  /* å…±ç”¨ */
  const [drawnNumbers, setDrawnNumbers] = useState([]);
  const [currentNumber, setCurrentNumber] = useState(null);
  const [roomId, setRoomId] = useState("");
  const [isConnected, setIsConnected] = useState(false);
  const [inputRoomId, setInputRoomId] = useState("");

  /* ===== å·¥å…· ===== */
  const generateBoard = () => {
    const nums = Array.from({ length: 53 }, (_, i) => i + 1)
      .sort(() => Math.random() - 0.5);
    return Array.from({ length: 6 }, (_, i) => nums.slice(i * 6, i * 6 + 6));
  };

  const roomKey = (r) => `bingo_room_${r}`;
  const playersKey = (r) => `bingo_players_${r}`;

  /* ===== åŒæ­¥ ===== */
  const syncRoom = () => {
    const data = JSON.parse(storage.get(roomKey(roomId)) || "{}");
    setDrawnNumbers(data.drawnNumbers || []);
    setCurrentNumber(data.currentNumber || null);

    const plist = JSON.parse(storage.get(playersKey(roomId)) || "[]");
    setPlayers(plist);

    if (!winner) {
      const win = plist.find(p => p.bingo);
      if (win) setWinner(win.name);
    }
  };

  useEffect(() => {
    if (isConnected && roomId) {
      const t = setInterval(syncRoom, 2000);
      return () => clearInterval(t);
    }
  }, [isConnected, roomId, winner]);

  /* ===== ç©å®¶å›å ± ===== */
  const reportPlayer = (lines) => {
    const list = JSON.parse(storage.get(playersKey(roomId)) || "[]")
      .filter(p => p.name !== playerName);

    list.push({
      name: playerName,
      lines,
      bingo: lines >= 1
    });

    storage.set(playersKey(roomId), JSON.stringify(list));
  };

  useEffect(() => {
    if (mode === "player" && isConnected) reportPlayer(bingoLines);
  }, [bingoLines]);

  /* ===== æŠ½è™Ÿ ===== */
  const drawNumber = () => {
    const remain = Array.from({ length: 53 }, (_, i) => i + 1)
      .filter(n => !drawnNumbers.includes(n));
    if (!remain.length) return;

    const num = remain[Math.floor(Math.random() * remain.length)];
    const newNums = [...drawnNumbers, num];
    setDrawnNumbers(newNums);
    setCurrentNumber(num);
    storage.set(roomKey(roomId), JSON.stringify({ drawnNumbers: newNums, currentNumber: num }));
  };

  /* ===== ç•«é¢ ===== */
  if (mode === "select") return (
    <div className="min-h-screen bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
      <div className="bg-white p-8 rounded-3xl shadow-2xl space-y-4 w-80">
        <button onClick={() => {
          setRoomId(Math.random().toString(36).substring(2,8).toUpperCase());
          setHostBoard(generateBoard());
          setMode("host");
          setIsConnected(true);
        }} className="w-full bg-blue-500 text-white py-4 rounded-xl font-bold">
          ğŸ¯ ä¸»æŒäºº
        </button>

        <button onClick={() => {
          setPlayerBoard(generateBoard());
          setMode("player");
        }} className="w-full bg-green-500 text-white py-4 rounded-xl font-bold">
          ğŸ® ç©å®¶
        </button>
      </div>
    </div>
  );

  /* ===== ä¸»æŒäºº ===== */
  if (mode === "host") return (
    <div className="min-h-screen bg-blue-600 p-4 text-white">
      <h1 className="text-2xl font-bold mb-2">ğŸ¯ ä¸»æŒäººæ§åˆ¶å°</h1>
      <p>æˆ¿é–“ä»£ç¢¼ï¼š<b>{roomId}</b></p>

      {winner && (
        <div className="bg-yellow-400 text-black p-3 rounded-xl my-3 font-bold">
          ğŸ† ç¬¬ä¸€ä½è³“æœï¼š{winner}
        </div>
      )}

      <button onClick={drawNumber}
        className="bg-green-500 px-6 py-3 rounded-xl font-bold my-3">
        â–¶ æŠ½è™Ÿ
      </button>

      <h3 className="font-bold mt-4">ğŸ‘¥ ç©å®¶åå–®</h3>
      <ul className="bg-white text-black rounded-xl p-3">
        {players.map((p,i)=>(
          <li key={i}>
            {p.name}ï½œé€£ç·š {p.lines} {p.bingo && "ğŸ‰"}
          </li>
        ))}
      </ul>
    </div>
  );

  /* ===== ç©å®¶åŠ å…¥ ===== */
  if (mode === "player" && !isConnected) return (
    <div className="min-h-screen bg-green-500 flex items-center justify-center">
      <div className="bg-white p-6 rounded-3xl shadow-xl w-80 space-y-3">
        <input placeholder="ç©å®¶å§“å"
          className="w-full border p-3 rounded-xl"
          value={inputPlayerName}
          onChange={e=>setInputPlayerName(e.target.value)} />

        <input placeholder="æˆ¿é–“ä»£ç¢¼"
          className="w-full border p-3 rounded-xl"
          value={inputRoomId}
          onChange={e=>setInputRoomId(e.target.value.toUpperCase())} />

        <button onClick={()=>{
          setPlayerName(inputPlayerName || "ç©å®¶");
          setRoomId(inputRoomId);
          setIsConnected(true);
        }} className="w-full bg-blue-500 text-white py-3 rounded-xl font-bold">
          åŠ å…¥
        </button>
      </div>
    </div>
  );

  /* ===== ç©å®¶ç•«é¢ ===== */
  return (
    <div className="min-h-screen bg-green-600 p-4 text-white">
      <h1 className="text-xl font-bold">ğŸ® {playerName} çš„è³“æœå¡</h1>
      <p>é€£ç·šæ•¸ï¼š{bingoLines}</p>
    </div>
  );
}

ReactDOM.render(<BingoGame />, document.getElementById("root"));
</script>
</body>
</html>
